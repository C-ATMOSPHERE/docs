debian 9 default <a href="https://packages.debian.org/stretch/php">php</a> vesrion 7.0

Содержимое файла.
```
{"382":{"rid":"382","name":["INCh0LLRj9GC0LDRjyDRgtGA0L7QuNGG0LA6INCc0LXRh9C4LCDQnNCw0LPQuNGPLCDQqNC60L7Qu9Cw","Seiken Tsukai no World Break "],"rating":"516","last":"382","moon":"https:\/\/streamguard.cc\/serial\/f07b9153c626fdd6c55e92b655d79b10\/iframe?nocontrols_translations=1&season=1","status":"2","type":"\u0422\u0412 (>12 \u044d\u043f.), 25 \u043c\u0438\u043d.","genre":"\u043f\u0440\u0438\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f","year":"0","day":"1","description":"0JrRgtC+INCx0Ysg0L3QtSDRhdC+0YLQtdC7INC30L3QsNGC0YwsINC60LXQvCDQvtC9INCx0YvQuyDQsiDQv9GA0L7RiNC70L7QuSDQttC40LfQvdC4LiDQktC+0LfQvNC+0LbQvdC+LCDQutGC0L4t0YLQviDRhtCw0YDQtdC8LCDQutGC0L4t0YLQviDRgNGL0YbQsNGA0LXQvCwg0LAg0LzQvtC20LXRgiDQuCDQv9GA0L7RgdGC0L7QuSDQvNGD0YXQvtC5LiDQlNCwLCDQt9Cy0YPRh9C40YIg0Y3RgtC+INC90LUg0L7Rh9C10L3RjC4g0J3QuNC60YLQviDQsdGLINC90LUg0YXQvtGC0LXQuyDQsdGL0YLRjCDQvNGD0YXQvtC5LCDQvtC00L3QsNC60L4sINGB0YPRgtGMINC30LDQutC70Y7Rh9Cw0LXRgtGB0Y8g0L3QtSDQsiDRjdGC0L7QvC4g0KHRg9GC0Ywg0LIg0YLQvtC8LCDRh9GC0L4g0YLQtSDQutCw0YfQtdGB0YLQstCwLCDQutC+0YLQvtGA0YvQvNC4INGC0Ysg0L7QsdC70LDQtNCw0Lsg0LIg0L\/RgNC+0YjQu9C+0Lkg0LbQuNC30L3QuCwg0LzQvtCz0YPRgiDQv9C+0LzQvtGH0Ywg0YLQtdCx0LUg0LIg0L\/RgNC10L7QtNC+0LvQtdC90LjQuCDRgtGA0YPQtNC90L7RgdGC0LXQuS4g0J7QsdGA0LXRgtC10L3QuNC4INGB0LXQsdGPINCyINC20LjQt9C90Lgg0LrQsNC6LdC90LjQutCw0LouINCSINGN0YLQvtC8INC4INCx0YPQtNC10YIg0LfQsNC60LvRjtGH0LDRgtGM0YHRjyDRgdGD0YLRjCDRgdC10LPQviDQkNC90LjQvNC1LiDQm9C40YjRjCDQt9C90LDRjywg0LrQtdC8INGC0Ysg0LHRi9C7INCyINC\/0YDQvtGI0LvQvtC5INC20LjQt9C90LgsINGC0Ysg0LHRg9C00LXRiNGMINC30L3QsNGC0YwsINGB0LzQvtC20LXRiNGMINC70Lgg0YLRiyDQt9Cw0YnQuNGC0LjRgtGMINGH0LXQu9C+0LLQtdGH0LXRgdGC0LLQvuKApg0K0J3QsNGIINCz0LvQsNCy0L3Ri9C5INCz0LXRgNC+0Lkg0JzQvtGA0L7RhdCwINCl0LDQuNC80YPRgNCwLCDQutCw0Log0YDQsNC3LCDQttC40LLQtdGCINCyINGC0LDQutC+0Lwg0LzQuNGA0LUuINCSINC80LjRgNC1LCDQs9C00LUg0LzQvtC20L3QviDRg9C30L3QsNGC0YwsINC60LXQvCDRgtGLINCx0YvQuyDQsiDQv9GA0L7RiNC70L7QuSDQttC40LfQvdC4LiDQkdGL0LvQviDQsdGLINGF0L7RgNC+0YjQviDRg9GC0LLQtdGA0LbQtNCw0YLRjCwg0LXRgdC70Lgg0LHRiyDQstGB0LUg0LHRi9C70L4g0YLQsNC6INC\/0YDQvtGB0YLQvi4g0KPQt9C90LDQuyDQutC10Lwg0YLRiyDQsdGL0Lsg0Lgg0YLQtdCx0LUg0YHRgtCw0LvQviDQu9C10LPRh9C1LiDQndC+INC90LUg0YLRg9GCLdGC0L4g0LHRi9C70L4uINCt0YLQviDQvtGH0LXQvdGMINC+0L\/QsNGB0L3Ri9C5INC80LjRgCwg0YEg0YHQvtC30LTQsNC90LjRj9C80LgsINC40LvQuCDQutCw0Log0LjRhSDQtdGJ0LUg0L3QsNC30YvQstCw0Y7RgiDCq9Cc0LXRgtCw0YTQuNC30LjRh9C10YHQutC40LUg0YHQvtC30LTQsNC90LjRj8K7LCDQutC+0YLQvtGA0YvQuSDQvdC1INC00LDRgdGCINGC0LXQsdC1INGB0L\/QsNGC0Ywg0YHQv9C+0LrQvtC50L3Qviwg0LXRgdC70Lgg0YLRiyDRgtCw0Log0LbQtSwg0LrQsNC6INC4INCl0LDQuNC80YPRgNCwLCDQvtGC0L3QvtGB0LjRiNGM0YHRjyDQuiDRgtCw0Log0L3QsNC30YvQstCw0LXQvNGL0LwgwqvQodC\/0LDRgdC40YLQtdC70Y\/QvMK7LiDQntC90Lgg0LzQvtCz0YPRgiDQv9C+0LzQvdC40YLRjCDRgtC+LCDQutC10Lwg0L7QvdC4INCx0YvQu9C4INCyINC\/0YDQvtGI0LvQvtC5INC20LjQt9C90LguINCS0YHQtSDQvtC90Lgg0LzQvtCz0YPRgiDQv9C+0LvRjNC30L7QstCw0YLRjNGB0Y8g0LzQsNCz0LjQtdC5LiDQrdGC0LAg0LzQsNCz0LjRjyDQv9C+0LfQstC+0LvRj9C10YIg0LjQvCDRgdGA0LDQttCw0YLRjNGB0Y8g0Lgg0L\/QvtCx0LXQttC00LDRgtGMIMKr0KHQvtC30LTQsNC90LjQucK7LiDQlNC70Y8g0L\/QvtC00LPQvtGC0L7QstC60Lgg0YHQv9Cw0YHQuNGC0LXQu9C10LksINGB0YPRidC10YHRgtCy0YPQtdGCINGB0L\/QtdGG0LjQsNC70YzQvdCw0Y8g0YjQutC+0LvQsCwg0LIg0LrQvtGC0L7RgNC+0Lkg0LjRhSDRgtGA0LXQvdC40YDRg9GO0YIuINCi0YPRgiDRgtC+INC4INC90LDRh9C40L3QsNC10YLRgdGPINC40YHRgtC+0YDQuNGPINC90LDRiNC10LPQviDQs9C70LDQstC90L7Qs9C+INCz0LXRgNC+0Y8sINCwINC10YHQu9C4INCx0YvRgtGMINGC0L7Rh9C90LXQtSwg0YLQviDRgdC+INCy0YHRgtGD0L\/QuNGC0LXQu9GM0L3QvtCz0L4g0Y3QutC30LDQvNC10L3QsOKApiDQodC80L7RgtGA0LjQvCE=","code":"seiken-tsukai-no-world-break"}}
```

Записываем информацию из файлов в массив.
```php
for($i=0; $i < 630; $i++){
    $tmp = json_decode(file_get_contents("/var/www/test.anilibria.tv/upload/cache/info$i.json"), true);
    foreach($tmp as $k => $v){
    $info["$k"] = $v; 
  }
}
```

PHP 7.0
```
PHP Fatal error:  Allowed memory size of 2097152 bytes exhausted (tried to allocate 8192 bytes)
```

PHP 7.3
```
Page generated in 0.0584 seconds. Peak memory usage: 2.85 MB
```

Тоже происходит, если запустить в цикле `Memcached::get()`
```php
$count = $cache->get('apiInfo');
for($i=0; $i < $count; $i++){
	$tmp = json_decode($cache->get("apiInfo$i"), true);
	foreach($tmp as $k => $v){
		$info["$k"] = $v; 
	}
}
```

<hr/>

Устанавливаем PHP  7.3

```
apt-get update
apt-get upgrade
apt-get install ca-certificates apt-transport-https
wget -q https://packages.sury.org/php/apt.gpg -O- | apt-key add -
echo "deb https://packages.sury.org/php/ stretch main" | tee /etc/apt/sources.list.d/php.list
apt-get update
apt-get install php7.3-fpm php7.3-cli php7.3-curl php7.3-mysql php7.3-mbstring curl
```

Настраиваем fpm pool.
```
# nano /etc/php/7.3/fpm/pool.d/anilibria.conf

[anilibria]
listen = /var/run/anilibria.sock

user = anilibria
group = www-data

listen.owner = anilibria
listen.group = www-data

pm = static
pm.max_children = 100
pm.max_requests = 1000

chdir = /

php_admin_value[error_log] = /var/www/anilibria/logs/php_error.log
php_admin_flag[log_errors] = on

php_admin_value[session.save_handler] = memcached
php_admin_value[session.save_path] = "/tmp/memcached.socket"
php_admin_value[disable_functions] = "apache_setenv, chown, chgrp, closelog, define_syslog_variables, dl, exec, ftp_exec, openlog, passthru, pcntl_exec, popen, posix_getegid, posix_geteuid, posix_getpwuid, posix_kill, posix_mkfifo, posix_setpgid, posix_setsid, posix_setuid, posix_uname, proc_close, proc_get_status, proc_nice, proc_open, proc_terminate, syslog, system, pcntl_alarm, pcntl_fork, pcntl_waitpid, pcntl_wait, pcntl_wifexited, pcntl_wifstopped, pcntl_wifsignaled, pcntl_wexitstatus, pcntl_wtermsig, pcntl_wstopsig, pcntl_signal, pcntl_signal_dispatch, pcntl_get_last_error, pcntl_strerror, pcntl_sigprocmask, pcntl_sigwaitinfo, pcntl_sigtimedwait, pcntl_exec, pcntl_getpriority, pcntl_setpriority, shell_exec"

php_admin_value[opcache.revalidate_freq] = 0
php_admin_value[mbstring.internal_encoding] = UTF-8
php_admin_value[mbstring.func_overload] = 2
php_admin_value[realpath_cache_size] = 4096k
php_admin_value[max_input_vars] = 10000
```
